# BeanFacroryå’ŒApplicationContext
å€ŸåŠ©SpringBootçš„å¼•å¯¼ç±»æ¥è®²BeanFactory ä¸ ApplicationContext çš„åŒºåˆ«
```c
 ConfigurableApplicationContext context = SpringApplication.run(A01.class, args);
        /*
            1. åˆ°åº•ä»€ä¹ˆæ˜¯ BeanFactory
                - å®ƒæ˜¯ ApplicationContext çš„çˆ¶æ¥å£
                - å®ƒæ‰æ˜¯ Spring çš„æ ¸å¿ƒå®¹å™¨, ä¸»è¦çš„ ApplicationContext å®ç°éƒ½ã€ç»„åˆã€‘äº†å®ƒçš„åŠŸèƒ½
         */
System.out.println(context);
```
é€‰ä¸­ **ConfigurableApplicationContext** æŒ‰ä½ **ctrl+alt+u **å¼¹å‡ºç±»å›¾
![image.png](https://cdn.nlark.com/yuque/0/2023/png/12600036/1677421068228-c3f0e0b4-313b-4704-9ebe-270f2e444c90.png#averageHue=%23c3ecc9&clientId=uc6787cfa-ff4c-4&from=paste&height=337&id=ud45bdd49&name=image.png&originHeight=506&originWidth=2246&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=45208&status=done&style=none&taskId=u2d32768b-d757-4ae0-ae25-47cbfe5224c&title=&width=1497.3333333333333)
å¯ä»¥çœ‹åˆ° ApplicaionContext é—´æ¥ç»§æ‰¿äº†BeanFactoryï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹BeanFactoryè¿›è¡Œäº†åŠŸèƒ½ä¸Šçš„æ‰©å±•ã€‚ä¸»è¦ä½“ç°åœ¨ä¸‹å›¾ã€‚ æ¯ç»§æ‰¿ä¸€ä¸ªçˆ¶ç±»å°±è¯´æ˜å…·å¤‡äº†ä¸€ä¸ªæ–°èƒ½åŠ›ã€‚è¯´æ˜ApplicationContextçš„åŠŸèƒ½æ¯”BeanFactoryå¤šã€‚
![image.png](https://cdn.nlark.com/yuque/0/2023/png/12600036/1677421789709-e04e086f-5694-44ec-b637-f6b318f42274.png#averageHue=%23c3ecc9&clientId=u53e4a65b-5f67-4&from=paste&height=335&id=u22cfdeb6&name=image.png&originHeight=502&originWidth=2256&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=42505&status=done&style=none&taskId=uf20b72ae-db94-4849-9c37-d3891deb880&title=&width=1504)

BeanFactoryæ‰æ˜¯Springçš„æ ¸å¿ƒå®¹å™¨ã€‚ApplicationContext å®ç°éƒ½ã€ç»„åˆã€‘äº†å®ƒçš„åŠŸèƒ½ã€‚æ¯”å¦‚getBean
```c
context.getBean("aaa");
```
æŒ‰ä½** ctrl +alt +b** è°ƒè½¬åˆ°å®ç°ç±»
![image.png](https://cdn.nlark.com/yuque/0/2023/png/12600036/1677422356944-3429e3db-38e0-44ed-9756-309d19090747.png#averageHue=%23c9eecd&clientId=u53e4a65b-5f67-4&from=paste&height=249&id=u910a13e8&name=image.png&originHeight=374&originWidth=1225&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=54889&status=done&style=none&taskId=uf6ba20eb-9834-4aa4-898e-e5c14475d63&title=&width=816.6666666666666)
å¯ä»¥çœ‹åˆ°å…ˆæ‹¿åˆ° beanFactoryå†å»è°ƒç”¨getBean()ï¼Œä¹Ÿå°±è¯´ApplictionContextæ‰©å±• beanFactoryæ˜¯é€šè¿‡ç»„åˆçš„æ–¹å¼ã€‚åŠŸèƒ½æ˜¯äººå®¶beanFactoryæä¾›çš„ã€‚ä»è¿™å¯ä»¥çœ‹å‡ºbeanFactoryæ›´ä¸ºæ ¸å¿ƒä¸€äº›ã€‚

æœ€åé€šè¿‡æ–­ç‚¹æŸ¥çœ‹åˆ°ApplicaionContextæœ‰ä¸ªæˆå‘˜å°±æ˜¯beanFactoryã€‚
![image.png](https://cdn.nlark.com/yuque/0/2023/png/12600036/1677426834042-9432f6a0-d257-4cb6-895a-5a7e64b4d487.png#averageHue=%23f5f0d1&clientId=u53e4a65b-5f67-4&from=paste&height=563&id=u2e620c6f&name=image.png&originHeight=845&originWidth=1817&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=162169&status=done&style=none&taskId=ud6915e88-b119-4076-9d06-aff60adf4c2&title=&width=1211.3333333333333)
beanç®¡ç†çš„æ–¹æ–¹é¢é¢éƒ½æ˜¯é€šè¿‡BeanFactoryæ¥ç®¡çš„ï¼ŒbeanFactoryé‡Œé¢æœ‰ä¸ªsingletonObjectsï¼Œç”¨æ¥ä¿å­˜å®¹å™¨ä¸­çš„å•ä¾‹å¯¹è±¡ã€‚
![image.png](https://cdn.nlark.com/yuque/0/2023/png/12600036/1677427064253-3e01af76-1b55-4841-889a-30770f84c3a8.png#averageHue=%23f9f7f5&clientId=u53e4a65b-5f67-4&from=paste&height=492&id=u1c1c20e1&name=image.png&originHeight=738&originWidth=1563&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=119089&status=done&style=none&taskId=uc69e2f64-6a16-4efc-b4a3-336a84860fa&title=&width=1042)

# BeanFactoryçš„åŠŸèƒ½
æ‰¾åˆ° **BeanFactory** æŒ‰ä½ **F12** å¯ä»¥æŸ¥çœ‹è¿™ä¸ªæ¥å£æˆ–è€…ç±»çš„å…¨éƒ¨æ–¹æ³•
![image.png](https://cdn.nlark.com/yuque/0/2023/png/12600036/1677920753200-eaf6a182-6e68-4f1f-83b8-7ba8dad65044.png#averageHue=%23faf9f8&clientId=u4cd225a2-c7f9-4&from=paste&height=693&id=ub9950cf6&name=image.png&originHeight=1040&originWidth=1284&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=77081&status=done&style=none&taskId=u36627490-0840-4209-8cc0-977f6b7a1d3&title=&width=856)
å¯ä»¥çœ‹åˆ°æ–¹æ³•æ¯”è¾ƒå°‘ï¼Œè¡¨é¢ä¸Šåªæœ‰getBean()ã€‚ä½†æ˜¯ä¸èƒ½åªçœ‹æ¥å£ï¼Œå®é™…ä¸Šæ§åˆ¶åè½¬ã€åŸºæœ¬çš„ä¾èµ–æ³¨å…¥ã€ç›´è‡³ Bean çš„ç”Ÿå‘½å‘¨æœŸçš„å„ç§åŠŸèƒ½, éƒ½ç”±å®ƒçš„å®ç°ç±»æä¾›ã€‚
è¿™é‡Œç¨å¾®æä¸€ä¸‹ **DefaultListableBeanFactory ï¼Œ**æŒ‰ä½** ctrl + alt+ u **æŸ¥çœ‹ç»§æ‰¿å…³ç³»å›¾ã€‚
![image.png](https://cdn.nlark.com/yuque/0/2023/png/12600036/1677921312782-41c2dd8c-0dad-49e2-bf93-d31df2dca9eb.png#averageHue=%23c4ecca&clientId=u4cd225a2-c7f9-4&from=paste&height=541&id=ue8ecd68c&name=image.png&originHeight=812&originWidth=2069&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=72464&status=done&style=none&taskId=u97ababe3-38c1-4693-86e7-8686ea869a9&title=&width=1379.3333333333333)
å¯ä»¥çœ‹åˆ°BeanFactoryåªæ˜¯ä¼—å¤šçˆ¶æ¥å£ä¸­çš„ä¸€ä¸ªè€Œå·²ï¼Œæä¾›äº†getBeanã€‚å…¶ä»–æ¥å£åˆ™æ˜¯æä¾›äº†å…¶ä»–çš„åŠŸèƒ½ï¼šSingletonBeanRegistry ï¼ˆèƒ½æ³¨å†Œå•ä¾‹ï¼‰ï¼ŒHierarchicalBeanFactory ï¼ˆå’Œçˆ¶å­å®¹å™¨ç›¸å…³ï¼‰ï¼ŒListableBeanFactory ï¼ˆå¯ä»¥åˆ—å‡ºå®¹å™¨ä¸­çš„æ‰€æœ‰beanï¼‰ï¼ŒBeanDefinitionRegistry ï¼ˆç”¨æ¥æ³¨å†Œæ–°çš„beanï¼‰ã€‚
 
DefaultListableBeanFactoryå¯ä»¥ç®¡ç†æ‰€æœ‰çš„beanï¼Œå…¶ä¸­å¤§å®¶æœ€ä¸ºå…³å¿ƒçš„å°±æ˜¯å•ä¾‹beançš„ç®¡ç†ã€‚è¿™ä¸ªåœ¨ä»–çˆ¶ç±»DefaultSingletonBeanRegistryä¸­ã€‚
![image.png](https://cdn.nlark.com/yuque/0/2023/png/12600036/1677921979660-95c643b7-5775-4436-a966-23206d72564d.png#averageHue=%23c6edcc&clientId=u4cd225a2-c7f9-4&from=paste&height=665&id=ud1cd224d&name=image.png&originHeight=997&originWidth=1648&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=136881&status=done&style=none&taskId=u709e9663-3a28-4f0a-a9ea-db1081179dd&title=&width=1098.6666666666667)
DefaultSingletonBeanRegistryçš„singletonObjectsä¸­å°±æ”¾ç€æ‰€æœ‰çš„å•ä¾‹beanã€‚
æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„è°ƒç”¨æ¥æŸ¥çœ‹singletonObjectsä¸­å­˜æ”¾çš„æ‰€æœ‰beanã€‚
```java
ConfigurableApplicationContext context = SpringApplication.run(A01.class, args);
Field singletonObjects = DefaultSingletonBeanRegistry.class.getDeclaredField("singletonObjects");
singletonObjects.setAccessible(true);
ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();
Map<String, Object> map = (Map<String, Object>) singletonObjects.get(beanFactory);
//.filter(e -> e.getKey().startsWith("component"))
map.entrySet().stream()
    .forEach(e -> {
        System.out.println(e.getKey() + "=" + e.getValue());
    });
```
# ApplicationContextçš„åŠŸèƒ½
## ä»‹ç»
æˆ‘ä»¬ç°åœ¨æ¥çœ‹ApplicationContextæ¯”èµ·BeanFactoryæ‰©å±•äº†å“ªäº›åŠŸèƒ½ã€‚
å†çœ‹ä¸€ä¸‹ç»§æ‰¿å…³ç³»å›¾
![image.png](https://cdn.nlark.com/yuque/0/2023/png/12600036/1677922790259-2ba9566b-16a1-44db-aa87-45faaaa443a2.png#averageHue=%23c4ecc9&clientId=u4cd225a2-c7f9-4&from=paste&height=365&id=uff480b6b&name=image.png&originHeight=547&originWidth=2058&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=41818&status=done&style=none&taskId=u22ef773e-97b0-4d31-9fe3-0ca2b67b96c&title=&width=1372)
ApplicationContextçš„æ‰©å±•åŠŸèƒ½ä¸»è¦ä½“ç°åœ¨ç»§æ‰¿çš„4ä¸ªçˆ¶æ¥å£ä¸Šé¢ï¼š
MessageSourceï¼ˆå…·å¤‡å¤„ç†å›½é™…åŒ–èµ„æºçš„èƒ½åŠ›ï¼‰
EnvironmentCapable ï¼ˆå¯ä»¥è¯»å–ç¯å¢ƒä¿¡æ¯ï¼Œæ¯”å¦‚è¯»å–ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œè¯»å–é…ç½®æ–‡ä»¶KVï¼‰
ResourcePatternResolver ï¼ˆé€šé…ç¬¦åŒ¹é…èµ„æºçš„èƒ½åŠ›ï¼‰
ApplicationEventPublisher ï¼ˆå‘å¸ƒäº‹ä»¶èƒ½åŠ›ï¼‰

## MessageSource
å…ˆæ¥è®²ä¸€ä¸‹MessageSourceã€‚è¯­è¨€çš„èµ„æºæ–‡ä»¶åœ¨é¡¹ç›®ä»£ç†é‡Œé¢å·²ç»æœ‰äº† 
![image.png](https://cdn.nlark.com/yuque/0/2023/png/12600036/1677923691261-d8d5ac07-8492-4481-aed2-7e72bec9c5e4.png#averageHue=%23f9f8f7&clientId=u4cd225a2-c7f9-4&from=paste&height=493&id=ua3c55449&name=image.png&originHeight=739&originWidth=555&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=34311&status=done&style=none&taskId=u47d2e037-c8c8-4a79-98cf-a180bf44376&title=&width=370)
```java
ConfigurableApplicationContext context = SpringApplication.run(A01.class, args);
//getMessageæ˜¯MessageSourceé‡Œé¢çš„æ–¹æ³•ã€‚
System.out.println(context.getMessage("hi", null, Locale.CHINA));
System.out.println(context.getMessage("hi", null, Locale.ENGLISH));
System.out.println(context.getMessage("hi", null, Locale.JAPANESE));
```
**è¾“å‡ºï¼š**
ä½ å¥½
Hello
ã“ã‚“ã«ã¡ã¯
å®é™…å¼€å‘ä¸­ï¼Œæµè§ˆå™¨é€šè¿‡è¯·æ±‚å¤´å¸¦ä¸Šè¯­è¨€å‚æ•°å‘Šè¯‰æœåŠ¡å™¨ä½¿ç”¨ä»€ä¹ˆè¯­è¨€ã€‚åå°å°±åŒ¹é…ç›¸åº”çš„è¯­è¨€ã€‚

## ResourcePatternResolver
é€šè¿‡getResourcesæ–¹æ³•è·å–èµ„æºã€‚
```java
ConfigurableApplicationContext context = SpringApplication.run(A01.class, args);
Resource[] resources = context.getResources("classpath:application.properties");
for (Resource resource : resources) {
    System.out.println(resource);
}
è¾“å‡ºï¼š
class path resource [application.properties]
```


ä¸Šè¿°ä»£ç åªèƒ½æ‰¾åˆ°ä¸€ä¸ªèµ„æºæ–‡ä»¶ã€‚æˆ‘ä»¬å†ä¸¾ä¸€ä¸ªèƒ½æ‰¾åˆ°å¤šä¸ªèµ„æºæ–‡ä»¶çš„ä¾‹å­ã€‚åœ¨SpringBootçš„spring.factoriesé‡Œé¢æœ‰ä¸€äº›è‡ªåŠ¨é…ç½®ç±»ï¼Œæˆ‘ä»¬æ¥è·å–ä¸€ä¸‹ã€‚
```java
ConfigurableApplicationContext context = SpringApplication.run(A01.class, args);
//classpathåªæ‰¾ç±»è·¯å¾„ä¸‹ï¼Œclasspath*jaråŒ…é‡Œé¢ä¹Ÿä¼šå»æ‰¾ã€‚
Resource[] resources = context.getResources("classpath*:META-INF/spring.factories");
for (Resource resource : resources) {
  System.out.println(resource);
 }

è¾“å‡ºï¼š
URL [file:/E:/Study/java/Spring%e9%ab%98%e7%ba%a7/%e4%bb%a3%e7%a0%81/show/target/classes/META-INF/spring.factories]
URL [jar:file:/E:/soft/maven/repository/org/springframework/boot/spring-boot/2.5.5/spring-boot-2.5.5.jar!/META-INF/spring.factories]
URL [jar:file:/E:/soft/maven/repository/org/springframework/boot/spring-boot-autoconfigure/2.5.5/spring-boot-autoconfigure-2.5.5.jar!/META-INF/spring.factories]
URL [jar:file:/E:/soft/maven/repository/org/springframework/spring-beans/5.3.10/spring-beans-5.3.10.jar!/META-INF/spring.factories]
URL [jar:file:/E:/soft/maven/repository/org/mybatis/spring/boot/mybatis-spring-boot-autoconfigure/2.2.0/mybatis-spring-boot-autoconfigure-2.2.0.jar!/META-INF/spring.factories]
URL [jar:file:/E:/soft/maven/repository/com/alibaba/druid-spring-boot-starter/1.2.8/druid-spring-boot-starter-1.2.8.jar!/META-INF/spring.factories]
URL [jar:file:/E:/soft/maven/repository/org/springframework/spring-test/5.3.10/spring-test-5.3.10.jar!/META-INF/spring.factories]
```
## EnvironmentCapable
ç”¨context.getEnvironmentè·å–ç¯å¢ƒå˜é‡ã€‚å…¶å®šä¹‰åœ¨EnvironmentCapableæ¥å£ä¸­
```java
ConfigurableApplicationContext context = SpringApplication.run(A01.class, args);
System.out.println(context.getEnvironment().getProperty("java_home"));
System.out.println(context.getEnvironment().getProperty("server.port"));
```
## ApplicationEventPublisher 
ç”¨context.publishEvent()å‘å¸ƒäº‹ä»¶ã€‚å…¶å®šä¹‰åœ¨ApplicationEventPublisher æ¥å£ä¸­ã€‚
è¦å‘å¸ƒäº‹ä»¶ï¼Œæˆ‘ä»¬å°±éœ€è¦å…ˆå®šä¹‰å¥½ä¸€ä¸ªäº‹ä»¶ï¼Œå†™ä¸€ä¸ªç±»ç»§æ‰¿ApplicationEventã€‚sourceå‚æ•°æ˜¯äº‹ä»¶æºï¼Œä¹Ÿå°±æ˜¯æ˜¯è°å‘çš„è¿™ä¸ªäº‹ä»¶ã€‚
```java
public class UserRegisteredEvent extends ApplicationEvent {
    public UserRegisteredEvent(Object source) {
        super(source);
    }
}
```

è¿˜éœ€è¦ä¸€ä¸ªäº‹ä»¶çš„æ¥æ”¶è€…ï¼Œè¿™é‡Œå®šä¹‰ä¸€ä¸ªComponent2æ¥æ¥æ”¶ã€‚
```java
@Component
public class Component2 {

    private static final Logger log = LoggerFactory.getLogger(Component2.class);

    @EventListener
    public void aaa(UserRegisteredEvent event) {
        log.debug("{}", event);
    }
}

```
æœ€åè°ƒç”¨context.publishEvent()å‘å¸ƒä¸€ä¸ªäº‹ä»¶ã€‚
```java
ConfigurableApplicationContext context = SpringApplication.run(A01.class, args);
context.publishEvent(new UserRegisteredEvent(context));
context.getBean(Component1.class).register();
```


äº‹ä»¶ä¸»è¦å¯ä»¥ç”¨æ¥è§£è€¦ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç±»å‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼Œåœ¨å¦ä¸€ä¸ªç±»å»æ¥å—è¿™ä¸ªäº‹ä»¶ï¼Œç„¶åå†è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚ä¸‹é¢ç”¨Compent1æ¥å‘å¸ƒäº‹ä»¶ï¼ŒCompent2æ¥æ¥æ”¶äº‹ä»¶ã€‚
```java
@Component
public class Component1 {

    private static final Logger log = LoggerFactory.getLogger(Component1.class);

    @Autowired
    private ApplicationEventPublisher context;

    public void register() {
        log.debug("ç”¨æˆ·æ³¨å†Œ");
        context.publishEvent(new UserRegisteredEvent(this));
    }

}

```
```java
@Component
public class Component2 {

    private static final Logger log = LoggerFactory.getLogger(Component2.class);

    @EventListener
    public void aaa(UserRegisteredEvent event) {
        log.debug("{}", event);
        log.debug("å‘é€çŸ­ä¿¡");
    }
}

```
æœ€åè°ƒç”¨Component1çš„registeræ–¹æ³•ï¼Œå»å‘å¸ƒäº‹ä»¶ã€‚
```java
ConfigurableApplicationContext context = SpringApplication.run(A01.class, args);
context.publishEvent(new UserRegisteredEvent(context));
context.getBean(Component1.class).register();
```
# æ€»ç»“
**æ”¶è·ğŸ’¡**

1. åˆ°åº•ä»€ä¹ˆæ˜¯ BeanFactory 
   1. å®ƒæ˜¯ ApplicationContext çš„çˆ¶æ¥å£
   2. å®ƒæ‰æ˜¯ Spring çš„æ ¸å¿ƒå®¹å™¨, ä¸»è¦çš„ ApplicationContext å®ç°éƒ½ã€ç»„åˆã€‘äº†å®ƒçš„åŠŸèƒ½ï¼Œã€ç»„åˆã€‘æ˜¯æŒ‡ 		 ApplicationContext çš„ä¸€ä¸ªé‡è¦æˆå‘˜å˜é‡å°±æ˜¯ BeanFactory
2. BeanFactory èƒ½å¹²ç‚¹å•¥ 
   1. è¡¨é¢ä¸Šåªæœ‰ getBean
   2. å®é™…ä¸Šæ§åˆ¶åè½¬ã€åŸºæœ¬çš„ä¾èµ–æ³¨å…¥ã€ç›´è‡³ Bean çš„ç”Ÿå‘½å‘¨æœŸçš„å„ç§åŠŸèƒ½ï¼Œéƒ½ç”±å®ƒçš„å®ç°ç±»æä¾›
   3. ä¾‹å­ä¸­é€šè¿‡åå°„æŸ¥çœ‹äº†å®ƒçš„æˆå‘˜å˜é‡ singletonObjectsï¼Œå†…éƒ¨åŒ…å«äº†æ‰€æœ‰çš„å•ä¾‹ bean
3. ApplicationContext æ¯” BeanFactory å¤šç‚¹å•¥ 
   1. ApplicationContext ç»„åˆå¹¶æ‰©å±•äº† BeanFactory çš„åŠŸèƒ½
   2. å›½é™…åŒ–ã€é€šé…ç¬¦æ–¹å¼è·å–ä¸€ç»„ Resource èµ„æºã€æ•´åˆ Environment ç¯å¢ƒã€äº‹ä»¶å‘å¸ƒä¸ç›‘å¬
   3. æ–°å­¦ä¸€ç§ä»£ç ä¹‹é—´è§£è€¦é€”å¾„ï¼Œäº‹ä»¶è§£è€¦

 
