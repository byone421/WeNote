# è‡ªåŠ¨é…ç½®åŸç†
```java
public class A41_1 {

    @SuppressWarnings("all")
    public static void main(String[] args) throws IOException {
        GenericApplicationContext context = new GenericApplicationContext();
        //æ˜¯å¦å¯ä»¥beanè¦†ç›–
        context.getDefaultListableBeanFactory().setAllowBeanDefinitionOverriding(false);
        context.registerBean("config", Config.class);
        context.registerBean(ConfigurationClassPostProcessor.class);
        context.refresh();

        for (String name : context.getBeanDefinitionNames()) {
            System.out.println(name);
        }
        System.out.println(">>>>>>>>>>>>>>>>>>>>>>>>>");
        System.out.println(context.getBean(Bean1.class));
    }

    @Configuration // æœ¬é¡¹ç›®çš„é…ç½®ç±»
    @Import(MyImportSelector.class)
    static class Config {
        @Bean
        public Bean1 bean1() {
            return new Bean1("æœ¬é¡¹ç›®");
        }
    }
    //ImportSelector ä¸å»¶è¿Ÿè§£æï¼šå…ˆè§£ææ¡†æ¶çš„ï¼Œå†è§£æè‡ªå·±é¡¹ç›®çš„ã€‚
    //DeferredImportSelector å»¶è¿Ÿè§£æ
    static class MyImportSelector implements DeferredImportSelector {
        @Override
        public String[] selectImports(AnnotationMetadata importingClassMetadata) {
//            System.out.println(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>");
//            for (String name : SpringFactoriesLoader.loadFactoryNames(EnableAutoConfiguration.class, null)) {
//                System.out.println(name);
//            }
//            System.out.println(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>");
            List<String> names = SpringFactoriesLoader.loadFactoryNames(MyImportSelector.class, null);
            return names.toArray(new String[0]);
        }
    }

    @Configuration // ç¬¬ä¸‰æ–¹çš„é…ç½®ç±»
    static class AutoConfiguration1 {
        @Bean
        @ConditionalOnMissingBean
        public Bean1 bean1() {
            return new Bean1("ç¬¬ä¸‰æ–¹");
        }
    }

    static class Bean1 {
        private String name;

        public Bean1() {
        }

        public Bean1(String name) {
            this.name = name;
        }

        @Override
        public String toString() {
            return "Bean1{" +
                   "name='" + name + '\'' +
                   '}';
        }
    }

    @Configuration // ç¬¬ä¸‰æ–¹çš„é…ç½®ç±»
    static class AutoConfiguration2 {
        @Bean
        public Bean2 bean2() {
            return new Bean2();
        }
    }

    static class Bean2 {

    }
}
```
# AopAutoConfiguration
```java
public class TestAopAuto {
    public static void main(String[] args) {
        GenericApplicationContext context = new GenericApplicationContext();
        StandardEnvironment env = new StandardEnvironment();
//        env.getPropertySources().addLast(new SimpleCommandLinePropertySource("--spring.aop.auto=true"));
        context.setEnvironment(env);
        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());
        context.registerBean(Config.class);
        context.refresh();
        for (String name : context.getBeanDefinitionNames()) {
            System.out.println(name);
        }
        System.out.println(">>>>>>>>>>>>>>>");
        AnnotationAwareAspectJAutoProxyCreator creator = context.getBean(
                "org.springframework.aop.config.internalAutoProxyCreator", AnnotationAwareAspectJAutoProxyCreator.class);
        System.out.println(creator.isProxyTargetClass());

    }

    @Configuration
    @Import(MyImportSelector.class)
    static class Config {

    }

    static class MyImportSelector implements DeferredImportSelector {
        @Override
        public String[] selectImports(AnnotationMetadata importingClassMetadata) {
            return new String[]{AopAutoConfiguration.class.getName()};
        }
    }
}

```
Spring Boot æ˜¯åˆ©ç”¨äº†è‡ªåŠ¨é…ç½®ç±»æ¥ç®€åŒ–äº† aop ç›¸å…³é…ç½®

- AOP è‡ªåŠ¨é…ç½®ç±»ä¸º org.springframework.boot.autoconfigure.aop.AopAutoConfiguration
- å¯ä»¥é€šè¿‡ spring.aop.auto=false ç¦ç”¨ aop è‡ªåŠ¨é…ç½®
- AOP è‡ªåŠ¨é…ç½®çš„æœ¬è´¨æ˜¯é€šè¿‡ @EnableAspectJAutoProxy æ¥å¼€å¯äº†è‡ªåŠ¨ä»£ç†ï¼Œå¦‚æœåœ¨å¼•å¯¼ç±»ä¸Šè‡ªå·±æ·»åŠ äº† @EnableAspectJAutoProxy é‚£ä¹ˆä»¥è‡ªå·±æ·»åŠ çš„ä¸ºå‡†
- @EnableAspectJAutoProxy çš„æœ¬è´¨æ˜¯å‘å®¹å™¨ä¸­æ·»åŠ äº† AnnotationAwareAspectJAutoProxyCreator è¿™ä¸ª bean åå¤„ç†å™¨ï¼Œå®ƒèƒ½å¤Ÿæ‰¾åˆ°å®¹å™¨ä¸­æ‰€æœ‰åˆ‡é¢ï¼Œå¹¶ä¸ºåŒ¹é…åˆ‡ç‚¹çš„ç›®æ ‡ç±»åˆ›å»ºä»£ç†ï¼Œåˆ›å»ºä»£ç†çš„å·¥ä½œä¸€èˆ¬æ˜¯åœ¨ bean çš„åˆå§‹åŒ–é˜¶æ®µå®Œæˆçš„

# DataSourceAutoConfiguration
```java
public class TestDataSourceAuto {
    @SuppressWarnings("all")
    public static void main(String[] args) {
        GenericApplicationContext context = new GenericApplicationContext();
        StandardEnvironment env = new StandardEnvironment();
        env.getPropertySources().addLast(new SimpleCommandLinePropertySource(
                "--spring.datasource.url=jdbc:mysql://localhost:3306/test",
                "--spring.datasource.username=root",
                "--spring.datasource.password=root"
        ));
        context.setEnvironment(env);
        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());
        context.registerBean(Config.class);

        String packageName = TestDataSourceAuto.class.getPackageName();
        System.out.println("å½“å‰åŒ…å:" + packageName);
        AutoConfigurationPackages.register(context.getDefaultListableBeanFactory(),
                packageName);

        context.refresh();
        for (String name : context.getBeanDefinitionNames()) {
            String resourceDescription = context.getBeanDefinition(name).getResourceDescription();
            if (resourceDescription != null)
                System.out.println(name + " æ¥æº:" + resourceDescription);
        }
    }

    @Configuration
    @Import(MyImportSelector.class)
    static class Config {

    }

    static class MyImportSelector implements DeferredImportSelector {
        @Override
        public String[] selectImports(AnnotationMetadata importingClassMetadata) {
            return new String[]{
                    DataSourceAutoConfiguration.class.getName(),
                    MybatisAutoConfiguration.class.getName(),
                    DataSourceTransactionManagerAutoConfiguration.class.getName(),
                    TransactionAutoConfiguration.class.getName()
            };
        }
    }
}
```

- å¯¹åº”çš„è‡ªåŠ¨é…ç½®ç±»ä¸ºï¼šorg.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
- å®ƒå†…éƒ¨é‡‡ç”¨äº†æ¡ä»¶è£…é…ï¼Œé€šè¿‡æ£€æŸ¥å®¹å™¨çš„ beanï¼Œä»¥åŠç±»è·¯å¾„ä¸‹çš„ classï¼Œæ¥å†³å®šè¯¥ @Bean æ˜¯å¦ç”Ÿæ•ˆ

ç®€å•è¯´æ˜ä¸€ä¸‹ï¼ŒSpring Boot æ”¯æŒä¸¤å¤§ç±»æ•°æ®æºï¼š

- EmbeddedDatabase - å†…åµŒæ•°æ®åº“è¿æ¥æ± 
- PooledDataSource - éå†…åµŒæ•°æ®åº“è¿æ¥æ± 

PooledDataSource åˆæ”¯æŒå¦‚ä¸‹æ•°æ®æº

- hikari æä¾›çš„ HikariDataSource
- tomcat-jdbc æä¾›çš„ DataSource
- dbcp2 æä¾›çš„ BasicDataSource
- oracle æä¾›çš„ PoolDataSourceImpl

å¦‚æœçŸ¥é“æ•°æ®æºçš„å®ç°ç±»ç±»å‹ï¼Œå³æŒ‡å®šäº† spring.datasource.typeï¼Œç†è®ºä¸Šå¯ä»¥æ”¯æŒæ‰€æœ‰æ•°æ®æºï¼Œä½†è¿™æ ·åšçš„ä¸€ä¸ªæœ€å¤§é—®é¢˜æ˜¯æ— æ³•è®¢åˆ¶æ¯ç§æ•°æ®æºçš„è¯¦ç»†é…ç½®ï¼ˆå¦‚æœ€å¤§ã€æœ€å°è¿æ¥æ•°ç­‰ï¼‰

# MybatisAutoConfiguration

- MyBatis è‡ªåŠ¨é…ç½®ç±»ä¸º `org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration`
- å®ƒä¸»è¦é…ç½®äº†ä¸¤ä¸ª bean 
   - SqlSessionFactory - MyBatis æ ¸å¿ƒå¯¹è±¡ï¼Œç”¨æ¥åˆ›å»º SqlSession
   - SqlSessionTemplate - SqlSession çš„å®ç°ï¼Œæ­¤å®ç°ä¼šä¸å½“å‰çº¿ç¨‹ç»‘å®š
   - ç”¨ ImportBeanDefinitionRegistrar çš„æ–¹å¼æ‰«ææ‰€æœ‰æ ‡æ³¨äº† [@Mapper ](/Mapper ) æ³¨è§£çš„æ¥å£ 
   - ç”¨ AutoConfigurationPackages æ¥ç¡®å®šæ‰«æçš„åŒ…
- è¿˜æœ‰ä¸€ä¸ªç›¸å…³çš„ beanï¼šMybatisPropertiesï¼Œå®ƒä¼šè¯»å–é…ç½®æ–‡ä»¶ä¸­å¸¦ `mybatis.` å‰ç¼€çš„é…ç½®é¡¹è¿›è¡Œå®šåˆ¶é…ç½®

[@MapperScan ](/MapperScan ) æ³¨è§£çš„ä½œç”¨ä¸ MybatisAutoConfiguration ç±»ä¼¼ï¼Œä¼šæ³¨å†Œ MapperScannerConfigurer æœ‰å¦‚ä¸‹åŒºåˆ« 

- [@MapperScan ](/MapperScan ) æ‰«æå…·ä½“åŒ…ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥é…ç½®å…³æ³¨å“ªä¸ªæ³¨è§£ï¼‰ 
- [@MapperScan ](/MapperScan ) å¦‚æœä¸æŒ‡å®šæ‰«æå…·ä½“åŒ…ï¼Œåˆ™ä¼šæŠŠå¼•å¯¼ç±»èŒƒå›´å†…ï¼Œæ‰€æœ‰æ¥å£å½“åš Mapper æ¥å£ 
- MybatisAutoConfiguration å…³æ³¨çš„æ˜¯æ‰€æœ‰æ ‡æ³¨ [@Mapper ](/Mapper ) æ³¨è§£çš„æ¥å£ï¼Œä¼šå¿½ç•¥æ‰é [@Mapper ](/Mapper ) æ ‡æ³¨çš„æ¥å£ 

è¿™é‡Œæœ‰åŒå­¦æœ‰ç–‘é—®ï¼Œä¹‹å‰ä»‹ç»çš„éƒ½æ˜¯å°†å…·ä½“ç±»äº¤ç»™ Spring ç®¡ç†ï¼Œæ€ä¹ˆåˆ°äº† MyBatis è¿™å„¿ï¼Œæ¥å£å°±å¯ä»¥è¢«ç®¡ç†å‘¢ï¼Ÿ

- å…¶å®å¹¶éå°†æ¥å£äº¤ç»™ Spring ç®¡ç†ï¼Œè€Œæ˜¯æ¯ä¸ªæ¥å£ä¼šå¯¹åº”ä¸€ä¸ª MapperFactoryBeanï¼Œæ˜¯åè€…è¢« Spring æ‰€ç®¡ç†ï¼Œæ¥å£åªæ˜¯ä½œä¸º MapperFactoryBean çš„ä¸€ä¸ªå±æ€§æ¥é…ç½®

# TransactionAutoConfiguration

-  äº‹åŠ¡è‡ªåŠ¨é…ç½®ç±»æœ‰ä¸¤ä¸ªï¼š 
   - `org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration`
   - `org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration`
-  å‰è€…é…ç½®äº† DataSourceTransactionManager ç”¨æ¥æ‰§è¡Œäº‹åŠ¡çš„æäº¤ã€å›æ»šæ“ä½œ 
-  åè€…åŠŸèƒ½ä¸Šå¯¹æ ‡ @EnableTransactionManagementï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ª bean 
   - BeanFactoryTransactionAttributeSourceAdvisor äº‹åŠ¡åˆ‡é¢ç±»ï¼ŒåŒ…å«é€šçŸ¥å’Œåˆ‡ç‚¹
   - TransactionInterceptor äº‹åŠ¡é€šçŸ¥ç±»ï¼Œç”±å®ƒåœ¨ç›®æ ‡æ–¹æ³•è°ƒç”¨å‰ååŠ å…¥äº‹åŠ¡æ“ä½œ
   - AnnotationTransactionAttributeSource ä¼šè§£æ [@Transactional ](/Transactional ) åŠäº‹åŠ¡å±æ€§ï¼Œä¹ŸåŒ…å«äº†åˆ‡ç‚¹åŠŸèƒ½ 
-  å¦‚æœè‡ªå·±é…ç½®äº† DataSourceTransactionManager æˆ–æ˜¯åœ¨å¼•å¯¼ç±»åŠ äº† @EnableTransactionManagementï¼Œåˆ™ä»¥è‡ªå·±é…ç½®çš„ä¸ºå‡† 
# ServletWebServerFactoryAutoConfiguration

- æä¾› ServletWebServerFactory
## DispatcherServletAutoConfiguration

- æä¾› DispatcherServlet
- æä¾› DispatcherServletRegistrationBean
## WebMvcAutoConfiguration

- é…ç½® DispatcherServlet çš„å„é¡¹ç»„ä»¶ï¼Œæä¾›çš„ bean è§è¿‡çš„æœ‰ 
   - å¤šé¡¹ HandlerMapping
   - å¤šé¡¹ HandlerAdapter
   - HandlerExceptionResolver
## ErrorMvcAutoConfiguration

- æä¾›çš„ bean æœ‰ BasicErrorController
## MultipartAutoConfiguration

- å®ƒæä¾›äº† org.springframework.web.multipart.support.StandardServletMultipartResolver
- è¯¥ bean ç”¨æ¥è§£æ multipart/form-data æ ¼å¼çš„æ•°æ®
## HttpEncodingAutoConfiguration

- POST è¯·æ±‚å‚æ•°å¦‚æœæœ‰ä¸­æ–‡ï¼Œæ— éœ€ç‰¹æ®Šè®¾ç½®ï¼Œè¿™æ˜¯å› ä¸º Spring Boot å·²ç»é…ç½®äº† org.springframework.boot.web.servlet.filter.OrderedCharacterEncodingFilter
- å¯¹åº”é…ç½® server.servlet.encoding.charset=UTF-8ï¼Œé»˜è®¤å°±æ˜¯ UTF-8
- å½“ç„¶ï¼Œå®ƒåªå½±å“é json æ ¼å¼çš„æ•°æ®

```java
public class TestMvcAuto {
    @SuppressWarnings("all")
    public static void main(String[] args) {
        AnnotationConfigServletWebServerApplicationContext context = new AnnotationConfigServletWebServerApplicationContext();
        context.registerBean(Config.class);
        context.refresh();
        for (String name : context.getBeanDefinitionNames()) {
            String source = context.getBeanDefinition(name).getResourceDescription();
            if (source != null) {
                System.out.println(name + " æ¥æº:" + source);
            }
        }
        context.close();

    }

    @Configuration
    @Import(MyImportSelector.class)
    static class Config {

    }

    static class MyImportSelector implements DeferredImportSelector {
        @Override
        public String[] selectImports(AnnotationMetadata importingClassMetadata) {
            return new String[]{
                    ServletWebServerFactoryAutoConfiguration.class.getName(),
                    DispatcherServletAutoConfiguration.class.getName(),
                    WebMvcAutoConfiguration.class.getName(),
                    ErrorMvcAutoConfiguration.class.getName()
            };
        }
    }
}

```
## æ¼”ç¤º - è‡ªåŠ¨é…ç½®ç±»åŸç†
##### å…³é”®ä»£ç 
å‡è®¾å·²æœ‰ç¬¬ä¸‰æ–¹çš„ä¸¤ä¸ªè‡ªåŠ¨é…ç½®ç±»
```
@Configuration // â¬…ï¸ç¬¬ä¸‰æ–¹çš„é…ç½®ç±»
static class AutoConfiguration1 {
    @Bean
    public Bean1 bean1() {
        return new Bean1();
    }
}

@Configuration // â¬…ï¸ç¬¬ä¸‰æ–¹çš„é…ç½®ç±»
static class AutoConfiguration2 {
    @Bean
    public Bean2 bean2() {
        return new Bean2();
    }
}
```
æä¾›ä¸€ä¸ªé…ç½®æ–‡ä»¶ META-INF/spring.factoriesï¼Œkey ä¸ºå¯¼å…¥å™¨ç±»åï¼Œå€¼ä¸ºå¤šä¸ªè‡ªåŠ¨é…ç½®ç±»åï¼Œç”¨é€—å·åˆ†éš”
```
MyImportSelector=\
AutoConfiguration1,\
AutoConfiguration2
```
_**æ³¨æ„**_

- ä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­ MyImportSelector ä¸ AutoConfiguration1ï¼ŒAutoConfiguration2 ä¸ºç®€æ´å‡çœç•¥äº†åŒ…åï¼Œè‡ªå·±æµ‹è¯•æ—¶è¯·å°†åŒ…åæ ¹æ®æƒ…å†µè¡¥å…¨

å¼•å…¥è‡ªåŠ¨é…ç½®
```
@Configuration // â¬…ï¸æœ¬é¡¹ç›®çš„é…ç½®ç±»
@Import(MyImportSelector.class)
static class Config { }

static class MyImportSelector implements DeferredImportSelector {
    // â¬‡ï¸è¯¥æ–¹æ³•ä» META-INF/spring.factories è¯»å–è‡ªåŠ¨é…ç½®ç±»åï¼Œè¿”å›çš„ String[] å³ä¸ºè¦å¯¼å…¥çš„é…ç½®ç±»
    public String[] selectImports(AnnotationMetadata importingClassMetadata) {
        return SpringFactoriesLoader
            .loadFactoryNames(MyImportSelector.class, null).toArray(new String[0]);
    }
}
```
# æ”¶è·ğŸ’¡

1. è‡ªåŠ¨é…ç½®ç±»æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªé…ç½®ç±»è€Œå·²ï¼Œåªæ˜¯ç”¨ META-INF/spring.factories ç®¡ç†ï¼Œä¸åº”ç”¨é…ç½®ç±»è§£è€¦
2. @Enable æ‰“å¤´çš„æ³¨è§£æœ¬è´¨æ˜¯åˆ©ç”¨äº† @Import
3. @Import é…åˆ DeferredImportSelector å³å¯å®ç°å¯¼å…¥ï¼ŒselectImports æ–¹æ³•çš„è¿”å›å€¼å³ä¸ºè¦å¯¼å…¥çš„é…ç½®ç±»å
4. DeferredImportSelector çš„å¯¼å…¥ä¼šåœ¨æœ€åæ‰§è¡Œï¼Œä¸ºçš„æ˜¯è®©å…¶å®ƒé…ç½®ä¼˜å…ˆè§£æ
```java
public class A41_2 {

    @SuppressWarnings("all")
    public static void main(String[] args) throws IOException {
        AnnotationConfigServletWebServerApplicationContext context = new AnnotationConfigServletWebServerApplicationContext();
        StandardEnvironment env = new StandardEnvironment();
        env.getPropertySources().addLast(new SimpleCommandLinePropertySource(
                "--spring.datasource.url=jdbc:mysql://localhost:3306/test",
                "--spring.datasource.username=root",
                "--spring.datasource.password=root"
        ));
        context.setEnvironment(env);
        context.registerBean("config", Config.class);
        context.refresh();

        for (String name : context.getBeanDefinitionNames()) {
            String resourceDescription = context.getBeanDefinition(name).getResourceDescription();
            if (resourceDescription != null)
                System.out.println(name + " æ¥æº:" + resourceDescription);
        }
        context.close();
    }

    @Configuration // æœ¬é¡¹ç›®çš„é…ç½®ç±»
//    @Import(MyImportSelector.class)
//    @Import(AutoConfigurationImportSelector.class)
    @EnableAutoConfiguration
    static class Config {
        @Bean
        public TomcatServletWebServerFactory tomcatServletWebServerFactory() {
            return new TomcatServletWebServerFactory();
        }
    }

    static class MyImportSelector implements DeferredImportSelector {
        @Override
        public String[] selectImports(AnnotationMetadata importingClassMetadata) {
            return SpringFactoriesLoader.loadFactoryNames(MyImportSelector.class, null).toArray(new String[0]);
        }
    }

    @Configuration // ç¬¬ä¸‰æ–¹çš„é…ç½®ç±»
    static class AutoConfiguration1 {
        @Bean
        public Bean1 bean1() {
            return new Bean1();
        }
    }

    @Configuration // ç¬¬ä¸‰æ–¹çš„é…ç½®ç±»
    static class AutoConfiguration2 {
        @Bean
        public Bean2 bean2() {
            return new Bean2();
        }
    }

    static class Bean1 {

    }
    static class Bean2 {

    }
}

```
